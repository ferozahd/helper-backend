<!doctype html>
<html lang="en" ang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">

<head th:replace="common/header :: common-header"></head>

<body>

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header Container
    ================================================== -->
        <header id="header-container" class="fullwidth" th:replace="common/header :: navbar">
        </header>
        <div class="clearfix"></div>
        <!-- Header Container / End -->

        <!-- Messages -->



        <!-- Dashboard Container -->
        <div class="dashboard-container">

            <!-- Dashboard Sidebar
    ================================================== -->
            <div class="dashboard-sidebar">
                <div class="dashboard-sidebar-inner" data-simplebar>
                    <div class="dashboard-nav-container">

                        <!-- Responsive Navigation Trigger -->
                        <a href="#" class="dashboard-responsive-nav-trigger">
                            <span class="hamburger hamburger--collapse">
                                <span class="hamburger-box">
                                    <span class="hamburger-inner"></span>
                                </span>
                            </span>
                            <span class="trigger-title">Dashboard Navigation</span>
                        </a>

                        <!-- Navigation -->
                        <div class="dashboard-nav">
                            <div class="dashboard-nav-inner">

                                <ul data-submenu-title="Start">
                                    <li><a href="dashboard.html"><i class="icon-material-outline-dashboard"></i>
                                            Dashboard</a></li>
                                    <li class="active"><a href="dashboard-messages.html"><i
                                                class="icon-material-outline-question-answer"></i> Messages <span
                                                class="nav-tag">2</span></a></li>
                                    <li><a href="dashboard-bookmarks.html"><i
                                                class="icon-material-outline-star-border"></i> Bookmarks</a></li>
                                    <li><a href="dashboard-reviews.html"><i
                                                class="icon-material-outline-rate-review"></i> Reviews</a></li>
                                </ul>

                                <ul data-submenu-title="Organize and Manage">
                                    <li><a href="#"><i class="icon-material-outline-business-center"></i> Jobs</a>
                                        <ul>
                                            <li><a href="dashboard-manage-jobs.html">Manage Jobs <span
                                                        class="nav-tag">3</span></a></li>
                                            <li><a href="dashboard-manage-candidates.html">Manage Candidates</a></li>
                                            <li><a href="dashboard-post-a-job.html">Post a Job</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="#"><i class="icon-material-outline-assignment"></i> Tasks</a>
                                        <ul>
                                            <li><a href="dashboard-manage-tasks.html">Manage Tasks <span
                                                        class="nav-tag">2</span></a></li>
                                            <li><a href="dashboard-manage-bidders.html">Manage Bidders</a></li>
                                            <li><a href="dashboard-my-active-bids.html">My Active Bids <span
                                                        class="nav-tag">4</span></a></li>
                                            <li><a href="dashboard-post-a-task.html">Post a Task</a></li>
                                        </ul>
                                    </li>
                                </ul>

                                <ul data-submenu-title="Account">
                                    <li><a href="dashboard-settings.html"><i class="icon-material-outline-settings"></i>
                                            Settings</a></li>
                                    <li><a href="index-logged-out.html"><i
                                                class="icon-material-outline-power-settings-new"></i> Logout</a></li>
                                </ul>

                            </div>
                        </div>
                        <!-- Navigation / End -->

                    </div>
                </div>
            </div>
            <!-- Dashboard Sidebar / End -->


            <!-- Dashboard Content
    ================================================== -->
            <div class="dashboard-content-container" data-simplebar>
                <div class="dashboard-content-inner">

                    <!-- Dashboard Headline -->
                    <div class="dashboard-headline">
                        <h3>Messages</h3>

                        <!-- Breadcrumbs -->
                        <nav id="breadcrumbs" class="dark">
                            <ul>
                                <li><a href="#">Home</a></li>
                                <li><a href="#">Dashboard</a></li>
                                <li>Messages</li>
                            </ul>
                        </nav>
                    </div>


                    <div>
                        <input id="username" type="text" />
                        <button type="button" class="btn btn-primary"> Entrer dans la discussion</button>

                        <button type="button" class="btn btn-primary" onclick="fetchAll()">Raffraichir</button>

                    </div>


                    <div class="messages-container margin-top-0">

                        <div class="messages-container-inner">




                            <!-- Messages -->
                            <div class="messages-inbox">
                                <div class="messages-headline">
                                    <div class="input-with-icon">


                                        <input id="autocomplete-input" type="text" placeholder="Search">
                                        <i class="icon-material-outline-search"></i>



                                    </div>
                                </div>


                                <ul id="usersList"> </ul>




                            </div>
                            <!-- Messages / End -->

                            <!-- Message Content -->
                            <div class="message-content">

                                <div class="messages-headline">
                                    <h4>Sindy Forest</h4>
                                    <a href="#" class="message-action"><i class="icon-feather-trash-2"></i> Delete
                                        Conversation</a>
                                </div>

                                <!-- Message Content Inner -->
                                <div class="message-content-inner">

                                    <!-- Time Sign -->
                                    <div class="message-time-sign">
                                        <span>28 June, 2019</span>
                                    </div>

                                    <div class="message-bubble me">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-01.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <p>Thanks for choosing my offer. I will start working on your project
                                                    tomorrow.</p>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <div class="message-bubble">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-02.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <p>Great. If you need any further clarification let me know. üëç</p>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <div class="message-bubble me">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-01.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <p>Ok, I will. üòâ</p>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <!-- Time Sign -->
                                    <div class="message-time-sign">
                                        <span>Yesterday</span>
                                    </div>

                                    <div class="message-bubble me">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-01.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <p>Hi Sindy, I just wanted to let you know that project is finished and
                                                    I'm waiting for your approval.</p>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <div class="message-bubble">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-02.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <p>Hi Tom! Hate to break it to you, but I'm actually on vacation üå¥
                                                    until Sunday so I can't check it now. üòé</p>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <div class="message-bubble me">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-01.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <p>Ok, no problem. But don't forget about last payment. üôÇ</p>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>

                                    <div class="message-bubble">
                                        <div class="message-bubble-inner">
                                            <div class="message-avatar"><img src="images/user-avatar-small-02.jpg"
                                                    alt="" /></div>
                                            <div class="message-text">
                                                <!-- Typing Indicator -->
                                                <div class="typing-indicator">
                                                    <span></span>
                                                    <span></span>
                                                    <span></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                                <!-- Message Content Inner / End -->

                                <!-- Reply Area -->
                                <div class="message-reply">
                                    <textarea cols="1" rows="1" placeholder="Your Message" data-autoresize></textarea>
                                    <button class="button ripple-effect">Send</button>
                                </div>

                            </div>
                            <!-- Message Content -->

                        </div>
                    </div>
                    <!-- Messages Container / End -->




                    <!-- Footer
        ================================================== -->
                    <div id="footer" th:replace="common/header :: footer"></div>


                    <!-- Scripts
        ================================================== -->
                    <script src="js/jquery-3.6.0.min.js"></script>
                    <script src="js/jquery-migrate-3.3.2.min.js"></script>
                    <script src="js/mmenu.min.js"></script>
                    <script src="js/tippy.all.min.js"></script>
                    <script src="js/simplebar.min.js"></script>
                    <script src="js/bootstrap-slider.min.js"></script>
                    <script src="js/bootstrap-select.min.js"></script>
                    <script src="js/snackbar.js"></script>
                    <script src="js/clipboard.min.js"></script>
                    <script src="js/counterup.min.js"></script>
                    <script src="js/magnific-popup.min.js"></script>
                    <script src="js/slick.min.js"></script>
                    <script src="js/custom.js"></script>

                    <!-- Snackbar // documentation: https://www.polonel.com/snackbar/ -->






                    <script>
                        // Snackbar for user status switcher
                        $('#snackbar-user-status label').click(function () {
                            Snackbar.show({
                                text: 'Your status has been changed!',
                                pos: 'bottom-center',
                                showAction: false,
                                actionText: "Dismiss",
                                duration: 3000,
                                textColor: '#fff',
                                backgroundColor: '#383838'
                            });
                        });
                    </script>


                    <!-- Google Autocomplete -->
                    <script>
                        function initAutocomplete() {
                            var options = {
                                types: ['(cities)'],
                                // componentRestrictions: {country: "FR"}
                            };

                            var input = document.getElementById('autocomplete-input');
                            var autocomplete = new google.maps.places.Autocomplete(input, options);
                        }

                        // Autocomplete adjustment for homepage
                        if ($('.intro-banner-search-form')[0]) {
                            setTimeout(function () {
                                $(".pac-container").prependTo(".intro-search-field.with-autocomplete");
                            }, 300);
                        }

                    </script>

                    <!-- Google API -->
                    <script
                        src="https://maps.googleapis.com/maps/api/js?key=&libraries=places&callback=initAutocomplete"></script>


<script src="js/chat.js"> </script>
<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
<script type="text/javascript">
    (function () {
        function select(str) {
            return document.querySelector(str);
        }

        function alertMessage(message, type) {
            let alerts = select("#alerts");

            let el = document.createElement("p")
            el.innerHTML = message
            el.classList.add(type)
            alerts.append(el)
            setTimeout(() => alerts.innerHTML = '', 5000)
        }

        function drawChat(chatUsername) {
            return `<div class="row text-center">\n  <h3>Chat with ${chatUsername}</h3>\n</div>\n<div id="chat_messages_${chatUsername}" class="row"></div>\n<br/>\n<div class="row">\n  <div class="col-md-4"><textarea id="chat_input_${chatUsername}"></textarea></div>\n  <div class="col-md-1"><input type="button" id="chat_send_to_${chatUsername}" value="Send"/></div>\n</div>`
        }

        function getChat(chatList, chatName) {
            let chatRoom = chatList.querySelector(`#chat_${chatName}`)
            if (chatRoom === null) {
                let el = document.createElement("div")
                el.id = `chat_${chatName}`
                el.innerHTML = drawChat(chatName)
                el.classList.add('row')
                chatList.append(el)
                return el;
            } else {
                return chatRoom
            }
        }

        function clickSendButton(chatRoom, toWhom, stompClient, username) {
            chatRoom.querySelector(`#chat_send_to_${toWhom}`).addEventListener('click', () => {
                let msgInput = chatRoom.querySelector(`#chat_input_${toWhom}`)
                let msg = msgInput.value;

                if (msg && msg !== '') {
                    stompClientSendMessage(stompClient, '/app/message', JSON.stringify({
                        toWhom: toWhom,
                        fromWho: username,
                        message: msg
                    }))
                    let messages = chatRoom.querySelector(`#chat_messages_${toWhom}`);
                    messages.innerHTML += `<div class="row"><div class="col-md-1">Me:</div><div class="col-md-8">${msg}</div></div>`
                    msgInput.value = ''
                } else {
                    alertMessage(`Message to user [${toWhom}] cannot be empty !!!`, "bg-danger")
                }
            }, true)
        }

        function displayMessage(chatList, stompClient, username, { fromWho, message }) {
            let chatRoom = getChat(chatList, fromWho);
            let messages = chatRoom.querySelector(`#chat_messages_${fromWho}`);
            messages.innerHTML += `<div class="row"><div class="col-md-1">${fromWho}:</div><div class="col-md-8">${message}</div></div>`

            clickSendButton(chatRoom, fromWho, stompClient, username)

        }

        function displayUserList(userList, chatList, username, stompClient) {
            const lis = userList.length === 0 ? "It looks like you are the only one in the chat room !!!" : userList
                .reduce((acc, item) => `${acc}<li id="user_${item}"><a href="#chat_${item}">${item}</a></a></li>`, "")

            select("#chat_user_list").innerHTML = `<ul>${lis}</ul>`

            userList.forEach(item => select(`#chat_user_list #user_${item}`).addEventListener('click', () => {
                clickSendButton(getChat(chatList, item), item, stompClient, username);
            }, true))
        }

        function stompSubscribe(stompClient, endpoint, callback) { //8
            stompClient.subscribe(endpoint, callback)
            return stompClient
        }

        function stompClientSendMessage(stompClient, endpoint, message) { // 9
            stompClient.send(endpoint, {}, message)
            return stompClient
        }

        function disconnect(stompClient, username, connectBtn, disconnectBtn, clicked = false) {
            connectBtn.disabled = false
            disconnectBtn.disabled = true
            if (clicked) {
                stompClientSendMessage(stompClient, '/app/unregister', username)
            }
            stompClient.disconnect() //6-1
        }

        function connect(username) { //1-1
            return new Promise((resolve, reject) => {
                let stompClient = Stomp.over(new SockJS('/chat'))
                stompClient.connect({}, (frame) => resolve(stompClient))
            })
        }

        //To guarantee that our page is completely loaded before we execute anything
        window.addEventListener('load', function (event) {
            let chatUsersList = [];
            let chatList = select("#chat_list");
            let connectButton = select("#webchat_connect");
            let disconnectButton = select("#webchat_disconnect");

          
            let username = select("#webchat_username").value;

            if (username == null || username === '') {
                alertMessage('Name cannot be empty!!!', 'bg-danger')
            } else {
                connect(username) //1
                    .then((stompClient) => stompSubscribe(stompClient, '/user/queue/newMember', (data) => { //2
                        console.log("data"+data)
                        chatUsersList = JSON.parse(data.body)
                        if (chatUsersList.length > 0) {
                            displayUserList(chatUsersList.filter(x => x != username), chatList, username, stompClient)
                        } else {
                            alertMessage("Username already exists!!!", "bg-danger")
                            disconnect(stompClient, username, connectButton, disconnectButton)
                        }
                    })).then((stompClient) => stompSubscribe(stompClient, '/topic/newMember', (data) => {  // 3
                        chatUsersList.push(data.body);
                        displayUserList(chatUsersList.filter(x => x != username), chatList, username, stompClient)
                    })).then((stompClient) => stompClientSendMessage(stompClient, '/app/register', username)) // 4
                    .then((stompClient) => stompSubscribe(stompClient, `/user/${username}/msg`, (data) => {
                        displayMessage(chatList, stompClient, username, JSON.parse(data.body))
                    }))
                    .then((stompClient) => { //5
                        connectButton.disabled = true;
                        disconnectButton.disabled = false;
                        disconnectButton.addEventListener('click', () => disconnect(stompClient, username, connectButton, disconnectButton, true), true); // 6
                        return stompClient;
                    }).then((stompClient) => stompSubscribe(stompClient, '/topic/disconnectedUser', (data) => { // 7
                        const userWhoLeft = data.body;
                        chatUsersList = chatUsersList.filter(x => x != userWhoLeft);
                        displayUserList(chatUsersList.filter(x => x != username), chatList, username, stompClient);
                        alertMessage(`User [${userWhoLeft}] left the chat room!!!`, "bg-success")
                    }))
                }
   
        });
    })();F
</script>

</body>

</html>