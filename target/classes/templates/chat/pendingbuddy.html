<!doctype html>
<html lang="en" ang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">

<head th:replace="common/header :: common-header"></head>


<body>

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header Container
    ================================================== -->
        <header id="header-container" class="fullwidth" th:replace="common/header :: navbar">
        </header>
        <div class="clearfix"></div>
        <!-- Header Container / End -->

        <!-- Messages -->



        <!-- Dashboard Container -->
        <div class="dashboard-container">

            <!-- Dashboard Sidebar ================================================== -->
            <div class="dashboard-sidebar">
                <div class="dashboard-sidebar-inner" data-simplebar>
                    <div class="dashboard-nav-container">

                        <!-- Responsive Navigation Trigger -->
                        <a href="#" class="dashboard-responsive-nav-trigger">
                            <span class="hamburger hamburger--collapse">
                                <span class="hamburger-box">
                                    <span class="hamburger-inner"></span>
                                </span>
                            </span>
                            <span class="trigger-title">Dashboard Navigation</span>
                        </a>

                        <!-- Navigation -->
                        <div class="dashboard-nav">
                            <div class="dashboard-nav-inner">

                                <ul data-submenu-title="Start">
                                    <li><a href="dashboard.html"><i class="icon-material-outline-dashboard"></i>
                                            Dashboard</a></li>
                                    <li class="active"><a href="dashboard-messages.html"><i
                                                class="icon-material-outline-question-answer"></i> Messages <span
                                                class="nav-tag">2</span></a></li>

                                    <li><a href="dashboard-bookmarks.html"><i
                                                class="icon-material-outline-star-border"></i> Bookmarks</a></li>
                                    <li><a href="dashboard-reviews.html"><i
                                                class="icon-material-outline-rate-review"></i> Reviews</a></li>
                                </ul>

                                <ul data-submenu-title="Organize and Manage">
                                    <li><a href="#"><i class="icon-material-outline-business-center"></i> Jobs</a>
                                        <ul>
                                            <li><a href="dashboard-manage-jobs.html">Manage Jobs <span
                                                        class="nav-tag">3</span></a></li>
                                            <li><a href="dashboard-manage-candidates.html">Manage Candidates</a></li>
                                            <li><a href="dashboard-post-a-job.html">Post a Job</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="#"><i class="icon-material-outline-assignment"></i> Tasks</a>
                                        <ul>
                                            <li><a href="dashboard-manage-tasks.html">Manage Tasks <span
                                                        class="nav-tag">2</span></a></li>
                                            <li><a href="dashboard-manage-bidders.html">Manage Bidders</a></li>
                                            <li><a href="dashboard-my-active-bids.html">My Active Bids <span
                                                        class="nav-tag">4</span></a></li>
                                            <li><a href="dashboard-post-a-task.html">Post a Task</a></li>
                                        </ul>
                                    </li>
                                </ul>



                                <ul data-submenu-title="Account">
                                    <li><a href="dashboard-settings.html"><i class="icon-material-outline-settings"></i>
                                            Settings</a></li>
                                    <li><a th.href="@{index-logged-out.html}"><i
                                                class="icon-material-outline-power-settings-new"></i> Logout</a></li>
                                </ul>

                            </div>
                        </div>
                        <!-- Navigation / End -->

                    </div>
                </div>
            </div>
            <!-- Dashboard Sidebar / End -->


            <!-- Dashboard Content
    ================================================== -->
            <div class="dashboard-content-container" data-simplebar>
                <div class="dashboard-content-inner">

                    <!-- Dashboard Headline -->
                    <div class="dashboard-headline">
                        <h3>Messages</h3>

                        <!-- Breadcrumbs -->
                        <nav id="breadcrumbs" class="dark">
                            <ul>
                                <li><a href="#">Home</a></li>
                                <li><a href="#">Dashboard</a></li>
                                <li>Messages</li>
                            </ul>
                        </nav>
                    </div>


                    <div>
                        <input id="username" type="text" />
                        <!-- <button type="button" class="btn btn-primary" id="pendingbuddylist"> Pending <b
                                id="totalpendinguser"></b></button>

                        <button type="button" class="btn btn-primary" onclick="fetchAll()">Raffraichir</button> -->

                    </div>




                    <div class="messages-container margin-top-0">

                        <div class="messages-container-inner">




                            <!-- Messages -->
                            <div class="messages-inbox">
                                <div class="messages-headline">
                                    <div class="input-with-icon">


                                        <input id="autocomplete-input" type="text" placeholder="Search">
                                        <i class="icon-material-outline-search"></i>



                                    </div>
                                </div>



                                <ul class="list-group" style="cursor: pointer;" id="usersList">

                                </ul>




                            </div>
                            <!-- Messages / End -->

                            <!-- Message Content -->
                            <div class="message-content">

                                <div id="messages-headline" class="messages-headline">
                                    <h4 id="activebuddy" activecid="disable">Select a buddy</h4>
                                    <a href="#" class="message-action"><i class="icon-feather-trash-2"></i> Delete
                                        Conversation</a>
                                </div>

                                <!-- Message Content Inner -->
                                <div id="message-container" class="message-content-inner">


                                </div>
                                <!-- Message Content Inner / End -->

                                <!-- Reply Area message-reply-->
                                <div style="
                                    border-top: 1px solid #eaeaea;
                                    padding: 30px;
                                    align-items: flex-start;
                                    margin-top: 15px;">


                                    <div class="col-12 " id="optionToHandleUser"></div>
                                    <br/>


                                    <form id="messageform">
                                        <!-- <div id="destinationId"></div>
                                    <textarea cols="1" rows="1" name="message" placeholder="Your Message"></textarea>
                                    <input type="submit" class="button ripple-effect" value="submit" /> -->
                                    </form>
                                </div>

                                <!-- <div id="messagefrom-container">

                                </div> -->


                            </div>
                            <!-- Message Content -->

                        </div>
                    </div>
                    <!-- Messages Container / End -->



                    <!-- Footer
        ================================================== -->
                    <div id="footer" th:replace="common/header :: footer"></div>


                    <!-- Scripts
        ================================================== -->
                    <script src="/js/jquery-3.6.0.min.js"></script>
                    <script src="/js/jquery-migrate-3.3.2.min.js"></script>
                    <script src="/js/mmenu.min.js"></script>
                    <script src="/js/tippy.all.min.js"></script>
                    <script src="/js/simplebar.min.js"></script>
                    <script src="/js/bootstrap-slider.min.js"></script>
                    <script src="/js/bootstrap-select.min.js"></script>
                    <script src="/js/snackbar.js"></script>
                    <script src="/js/clipboard.min.js"></script>
                    <script src="/js/counterup.min.js"></script>
                    <script src="/js/magnific-popup.min.js"></script>
                    <script src="/js/slick.min.js"></script>
                    <script src="/js/custom.js"></script>

                    <!-- Snackbar // documentation: https://www.polonel.com/snackbar/ -->

                    <!-- Stomp and client socket library  -->

                    <!-- <script src="/webjars/sockjs-client/sockjs.min.js"></script>
                    <script src="/webjars/stomp-websocket/stomp.min.js">
                    </script> -->

                    <script th.inline="javascript">

                        window.onload = function () {
                            const messageForm = document.getElementById("messageform");
                            messageForm.onsubmit = function (event) {
                                if ($("#ispended").val() == "false") {
                                    event.preventDefault();
                                }
                                if ($("#message_body").val().length != 0) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/api/chat/sendmessage",
                                        data: {
                                            destinationId: $("#destinationId").val(),
                                            messagebody: $("#message_body").val()
                                        },
                                        success: async function (result) {

                                            let message = document.createElement("div")
                                            message.classList.add("message-bubble");
                                            message.classList.add("me");

                                            let output =
                                                '<div class="message-bubble-inner "><div class="message-avatar"><img src="/images/user-avatar-small-01.jpg" alt="" /></div><div class="message-text"><p>'
                                                + result.message + '</p></div></div ><div class="clearfix"></div>'
                                            message.innerHTML = output;
                                            $("#message-container").append(message);
                                            $("#message_body").val("")
                                        }
                                    });
                                }
                            }

                            $.ajax({
                                type: "POST",
                                url: "/api/chat/buddylist",
                                // data: data,
                                success: async function (result) {
                                    let output = "";
                                    Object.keys(result).forEach(function (k) {
                                        let cid = result[k].reciverLink == null ? "pended_" + Date.now() : result[k].reciverLink;
                                        output += "<li class='list-group-item buddylist ' cid-data='" + cid + "' id='senderId_" + result[k].receiver + "' >" + result[k].receiverName + "</li>";
                                    })

                                    $("#usersList").html(output)
                                }

                            });

                            document.getElementById("usersList").addEventListener("click", function (e) {

                                if (e.target && e.target.nodeName == "LI") {
                                    $("#activebuddy").html(e.target.innerHTML);
                                    $("#message-container").html("")
                                    let buddyId = e.target.id.slice(9);
                                    const communicationID = e.target.getAttribute("cid-data");
                                    $("#activebuddy").attr("activecid", communicationID)
                                    let ispended = communicationID == "pended" ? true : false;
                                    // 
                                    $("#optionToHandleUser").html("<button class='btn btn-danger'>Block</button><button class='btn btn-warning ml-2'>Ignore</button>")
                                    $("#messageform").html('<input type="hidden" id="destinationId" value="' + buddyId + '"/><input type="hidden" id="ispended" value="' + ispended + '"/><textarea id="message_body" cols="1" rows="1" name="message" placeholder="Your Message"></textarea><input type="submit" class="button ripple-effect" value="submit" />')
                                    // 

                                    $.ajax({
                                        type: "POST",
                                        url: "/api/chat/getmessages",
                                        data: { buddyId: buddyId },
                                        success: async function (result) {

                                            // $("#message-container").html("<div style='width:100%;height:100%' id='" + communicationID + "'></div>")
                                            // if (result.message.length === 0) {
                                            //     $("#message-container").html("<h2>Do your first message</h1>")
                                            // }
                                            if (communicationID === "pended") {
                                                $("#message-container").html("<h3>Do your first response</h3>")
                                            }
                                            result.message.forEach((data) => {
                                                let message = document.createElement("div")
                                                message.classList.add("message-bubble");
                                                result.me === data.communicationId ? message.classList.add("me") : '';
                                                let output =
                                                    '<div class="message-bubble-inner "><div class="message-avatar"><img src="/images/user-avatar-small-01.jpg" alt="" /></div><div class="message-text"><p>'
                                                    + data.message + '</p></div></div ><div class="clearfix"></div>'
                                                message.innerHTML = output;
                                                $("#message-container").append(message);
                                            })
                                            if (communicationID.slice(0, 6) === "pended") {
                                                $("#message-container").append("<h3 style='color:#AA3030'>You're pended, wait till respon</h3>")
                                            }


                                        }

                                    });
                                }
                            });


                            $.ajax({
                                type: "POST",
                                url: "/api/chat/pendingbuddy",
                                data: {},
                                success: async function (result) {

                                    let output = "";
                                    Object.keys(result).forEach(function (k) {
                                        output += "<li class='list-group-item buddylist pendingbuddy' cid-data='pended' id='senderId_" + result[k].id + "' >" + result[k].username + "</li>";
                                    })
                                    $("#usersList").html(output)
                                }
                            })


                        }



                    </script>
                    <script th:inline="javascript">

                            (function () {


                                function stompSubscribe(stompClient, endpoint, callback) { //8
                                    stompClient.subscribe(endpoint, callback)
                                    return stompClient
                                }

                                function stompClientSendMessage(stompClient, endpoint, message) { // 9
                                    stompClient.send(endpoint, {}, message)
                                    return stompClient
                                }

                                function connect() {

                                    return new Promise((resolve, reject) => {
                                        let stompClient = Stomp.over(new SockJS('/chat'))
                                        stompClient.connect({}, (frame) => resolve(stompClient))
                                    })
                                }

                                window.addEventListener('load', function (event) {

                                    const userid =/*[[${userid}]]*/ 'default';

                                    connect()
                                        .then((stompClient) => stompSubscribe(stompClient, `/user/${userid}/msg`, (data) => {
                                            let body = JSON.parse(data.body);
                                            let message = document.createElement("div")
                                            message.classList.add("message-bubble");


                                            let output =
                                                '<div class="message-bubble-inner "><div class="message-avatar"><img src="/images/user-avatar-small-01.jpg" alt="" /></div><div class="message-text"><p>'
                                                + body.message + '</p></div></div ><div class="clearfix"></div>'
                                            message.innerHTML = output;
                                            if (body.communicationId == $("#activebuddy").attr("activecid")) {
                                                $("#message-container").append(message);
                                                let sound = document.createElement("audio");
                                                sound.src = "/audio/bounce.mp3";
                                                sound.setAttribute("preload", "auto");
                                                sound.setAttribute("controls", "none");
                                                sound.style.display = "none";
                                                document.body.appendChild(sound);
                                                sound.play();
                                            }
                                        }))
                                        .then((stompClient) => stompSubscribe(stompClient, `/user/${userid}/pendingbuddy`, (data) => {
                                            window.location.href = "pendingbuddy/" + JSON.parse(data.body).id
                                        }))
                                });
                            })();
                    </script>








</body>

</html>